<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Acceso · Tecnomedica Montajes Industriales S.A.</title>
  <meta name="theme-color" content="#1e88e5"/>
  <link rel="icon" href="Logo.png" type="image/png"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --text:#111827; --muted:#6b7280; --primary:#1e88e5;
      --logo-max-h:100px;            /* altura máxima del logo (desktop) */
      --logo-max-h-sm:70px;         /* altura máxima del logo (móvil)   */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);margin:0;padding:16px}
    .app{width:min(92vw,860px);margin:24px auto}
    .card{background:var(--card);border-radius:24px;padding:24px 28px;box-shadow:0 16px 48px rgba(0,0,0,.10);margin-bottom:18px}

    /* Marca en fila: logo no cuadrado, mantiene proporción (max-height) */
    .brand-row{display:flex;align-items:center;gap:16px;margin-bottom:12px}
    .brand-row img{
      max-height:var(--logo-max-h); width:auto; height:auto; object-fit:contain;
      border-radius:12px; background:#fff; box-shadow:0 6px 20px rgba(0,0,0,.12);
    }
    .brand-row .title{font-size:26px;font-weight:800;color:var(--text);letter-spacing:.2px}

    h2{margin:8px 0 14px;color:var(--text);font-size:30px}
    label{display:block;font-size:14px;color:var(--muted);margin:6px 0 4px}
    input{width:100%;padding:14px 16px;border-radius:14px;border:1px solid #d8dee8;background:#fff;font-size:16px}
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{padding:13px 18px;border:0;border-radius:14px;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .btn.light{background:#e9eef5;color:#333}
    .link{background:none;border:0;color:var(--primary);padding:0;margin-top:6px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .big{font-size:22px;font-weight:800}
    #msg,#msg2{margin-top:8px;color:#b42318;min-height:18px}

    @media (max-width:540px){
      .app{width:96vw}
      .brand-row img{max-height:var(--logo-max-h-sm)}
      .brand-row .title{font-size:20px}
      h2{font-size:24px}
    }
  </style>
</head>
<body>
<div class="app">

  <!-- LOGIN -->
  <div class="card" id="authCard">
    <div class="brand-row">
      <img src="Logo.png" alt="Tecnomedica Montajes Industriales S.A.">
      <div class="title">Tecnomedica Montajes Industriales S.A.</div>
    </div>

    <h2>Iniciar sesión</h2>
    <label for="email">Correo</label>
    <input id="email" type="email" placeholder="correo@dominio.com" autocomplete="username" inputmode="email">
    <label for="password">Contraseña</label>
    <input id="password" type="password" placeholder="••••••••" autocomplete="current-password">
    <div class="row" style="margin-top:12px">
      <button class="btn" id="btnLogin">Entrar</button>
      <button class="link" id="btnForgot">¿Olvidaste tu contraseña?</button>
    </div>
    <div id="msg" class="muted"></div>
  </div>

  <!-- RESET PASSWORD -->
  <div class="card" id="resetCard" style="display:none;">
    <div class="brand-row">
      <img src="Logo.png" alt="Tecnomedica Montajes Industriales S.A.">
      <div class="title">Tecnomedica Montajes Industriales S.A.</div>
    </div>

    <h2>Define una nueva contraseña</h2>
    <label for="newPassword">Nueva contraseña</label>
    <input id="newPassword" type="password" placeholder="••••••••" autocomplete="new-password">
    <div class="row" style="margin-top:12px">
      <button class="btn" id="btnSetNew">Guardar nueva contraseña</button>
      <button class="link" id="btnCancelReset">Cancelar</button>
    </div>
    <div id="msg2" class="muted"></div>
  </div>

  <!-- HOME DEL EMPLEADO -->
  <div class="card" id="mainCard" style="display:none;">
    <div class="brand-row" style="margin-bottom:6px">
      <img src="Logo.png" alt="Tecnomedica Montajes Industriales S.A.">
      <div class="title">Tecnomedica Montajes Industriales S.A.</div>
    </div>

    <div class="row">
      <div>
        <div class="muted">Empleado</div>
        <div id="empName" class="big">—</div>
        <div id="empUid" class="muted">—</div>
      </div>
      <button class="btn light" id="btnLogout">Salir</button>
    </div>
  </div>

</div>

<script>
/* ====== SUPABASE (tus valores actuales) ====== */
const SUPABASE_URL = 'https://xducrljbdyneyihjcjvo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkdWNybGpiZHluZXlpaGpjanZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMTYzNDIsImV4cCI6MjA2Nzg5MjM0Mn0.I0JcXD9jUZNNefpt5vyBFBxwQncV9TSwsG8FHp0n85Y';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const authCard  = document.getElementById('authCard');
const mainCard  = document.getElementById('mainCard');
const resetCard = document.getElementById('resetCard');
const msg  = document.getElementById('msg');
const msg2 = document.getElementById('msg2');
let isRecovery = false;

function show(view){
  authCard.style.display  = (view==='auth')  ? 'block':'none';
  mainCard.style.display  = (view==='main')  ? 'block':'none';
  resetCard.style.display = (view==='reset') ? 'block':'none';
}

/* Detecta recuperación desde URL */
function detectRecoveryFromUrl(){
  const hash = window.location.hash || '';
  const qs = new URLSearchParams(window.location.search);
  if (hash.includes('type=recovery') || qs.get('type') === 'recovery') {
    isRecovery = true; show('reset');
  }
}
window.addEventListener('hashchange', detectRecoveryFromUrl);
detectRecoveryFromUrl();

/* Render (sin salir del reset hasta guardar) */
async function render() {
  if (isRecovery) { show('reset'); return; }
  const { data:{ user } } = await supabase.auth.getUser();
  if (!user) { show('auth'); return; }
  const { data: emp, error } = await supabase
    .from('employees')
    .select('employee_uid, full_name, login_enabled, status')
    .eq('user_id', user.id)
    .maybeSingle();
  if (error || !emp) {
    msg.textContent = error ? error.message : 'Sin vínculo en employees.user_id o login deshabilitado.';
    await supabase.auth.signOut(); show('auth'); return;
  }
  document.getElementById('empName').textContent = emp.full_name || '(sin nombre)';
  document.getElementById('empUid').textContent  = 'employee_uid: ' + emp.employee_uid;
  show('main');
}

/* Login */
document.getElementById('btnLogin').onclick = async ()=>{
  msg.textContent = '';
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  if (!email || !password){ msg.textContent = 'Escribe correo y contraseña.'; return; }
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) { msg.textContent = error.message; return; }
  render();
};

/* Forgot password */
document.getElementById('btnForgot').onclick = async ()=>{
  msg.textContent = '';
  const email = document.getElementById('email').value.trim();
  if (!email) { msg.textContent = 'Escribe tu correo y vuelve a pulsar.'; return; }
  const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
  msg.textContent = error ? error.message : 'Te envié un correo para restablecer la contraseña.';
};

/* Guardar nueva contraseña */
document.getElementById('btnSetNew').onclick = async ()=>{
  msg2.textContent = '';
  const np = document.getElementById('newPassword').value;
  if (!np || np.length < 6) { msg2.textContent = 'La contraseña debe tener al menos 6 caracteres.'; return; }
  const { error } = await supabase.auth.updateUser({ password: np });
  if (error) { msg2.textContent = error.message; return; }
  msg2.textContent = 'Contraseña actualizada. Ahora puedes iniciar sesión.';
  history.replaceState(null, '', window.location.pathname);
  isRecovery = false; await supabase.auth.signOut(); show('auth');
};

/* Cancelar recuperación */
document.getElementById('btnCancelReset').onclick = ()=>{
  history.replaceState(null, '', window.location.pathname);
  isRecovery = false; show('auth');
};

/* Mantener reset si llega el evento de recuperación */
supabase.auth.onAuthStateChange((event) => {
  if (event === 'PASSWORD_RECOVERY') { isRecovery = true; show('reset'); return; }
  if (isRecovery) { show('reset'); return; }
  render();
});
render();
</script>
</body>
</html>
